<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mapas de Partidos Políticos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fuentes y Leaflet CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- PapaParse y SheetJS -->
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    :root { --primary: #1D6F42; --map-btn: #4a90e2; --map-btn-hover: #357ab8; --bg: #f7f9fc; --card-bg: #fff; --text: #333; --radius:8px; --font:'Inter',sans-serif; }
    * { box-sizing:border-box; }
    body,html { margin:0;padding:0;width:100%;height:100%;font-family:var(--font);background:var(--bg);color:var(--text); }
    #container { width:90%;max-width:1200px;margin:20px auto; }
    h3 { margin:0 0 10px;font-weight:600; }

    /* Navegación de mapas */
    #mapNav { text-align:center;margin-bottom:10px; }
    .map-btn { background:var(--map-btn);color:#fff;border:none;padding:6px 12px;margin:0 5px;border-radius:var(--radius);cursor:pointer;font-weight:600;transition:background .2s; }
    .map-btn:hover { background:var(--map-btn-hover); }

    /* Mapa y lista de países */
    #mapAndSidebar { display:grid;grid-template-columns:1fr 250px;gap:20px; }
    #map { width:100%;height:60vh;border-radius:var(--radius);box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .leaflet-container:focus, #map:focus { outline:none!important; }
    #countryList { background:var(--card-bg);border-radius:var(--radius);padding:15px;height:60vh;overflow-y:auto;box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    .country-item { padding:8px 12px;border-radius:var(--radius);margin-bottom:6px;cursor:pointer;transition:background .2s; }
    .country-item:hover, .country-item.active { background:#4a90e2;color:#fff; }

    /* Descarga */
    #downloadZone { margin-top:30px;background:var(--card-bg);padding:20px;border-radius:var(--radius);box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    #downloadZone h3 { margin-bottom:15px; display:flex; justify-content: space-between; align-items: center; }
    #downloadZone h3 span { font-weight:400; color:#000; margin-left:8px; }
    #downloadZone label { font-weight:600;margin-bottom:8px;display:block; }
    #partySearch { width:100%;padding:8px 12px;margin-bottom:12px;border:1px solid #ccc;border-radius:var(--radius); }
    #partyList { display:flex;flex-wrap:wrap;gap:8px;max-height:200px;overflow-y:auto;margin-bottom:12px; }
    .party-chip { padding:6px 12px;border-radius:var(--radius);background:#e4e7ed;cursor:pointer;transition:background .2s,color .2s; }
    .party-chip.selected { background:#4a90e2;color:#fff; }

    /* Botón de descarga estilo Uiverse, icono alineado al borde */
    .button {
      position: relative;
      width: 180px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #17795E;
      background-color: #209978;
      overflow: hidden;
      margin: 0 auto;
    }
    .button, .button__icon, .button__text {
      transition: all 0.3s;
    }
    .button .button__text {
      transform: translateX(0);
      color: #fff;
      font-weight: 600;
      padding-right: 40px;
    }
    .button .button__icon {
      position: absolute;
      right: 0;
      top: 0;
      height: 100%;
      width: 40px;
      background-color: #17795E;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .button .svg {
      width: 20px;
      fill: #fff;
    }
    .button:hover {
      background: #17795E;
    }
    .button:hover .button__text {
      color: transparent;
    }
    .button:hover .button__icon {
      width: 100%;
      transform: translateX(0);
    }
    .button:active .button__icon {
      background-color: #146c54;
    }
    .button:active {
      border: 1px solid #146c54;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="mapNav">
      <button class="map-btn" id="prevMap">&lt; Prev</button>
      <span id="mapTitle">Europa</span>
      <button class="map-btn" id="nextMap">Next &gt;</button>
    </div>
    <div id="mapAndSidebar">
      <div id="map"></div>
      <div id="countryList"><h3>Países</h3></div>
    </div>
    <div id="downloadZone">
      <h3>Descarga de Partidos <span id="selectedCountry"></span></h3>
      <label for="partySearch">Buscar partido</label>
      <input type="text" id="partySearch" placeholder="Filtrar partidos..." disabled />
      <div id="partyList"></div>
      <button id="btnDownload" class="button" disabled>
        <span class="button__text">Download data</span>
        <span class="button__icon">
          <svg class="svg" viewBox="0 0 24 24"><path d="M12 16l4-5h-3V4h-2v7H8l4 5zM4 18h16v2H4z"/></svg>
        </span>
      </button>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const allCountries = ['Austria','France','Germany','Italy','Portugal','Spain','Switzerland','United Kingdom','Canada','Australia'];
      const countryListEl = document.getElementById('countryList');
      allCountries.forEach(name => {
        const div = document.createElement('div');
        div.className = 'country-item';
        div.textContent = name;
        div.onclick = () => selectCountry(name);
        countryListEl.appendChild(div);
      });

      const maps = [
        { name:'Europa', file:'europe.geojson', prop:'NAME', bounds:[[20,-40],[72,50]], zoom:4,
          style:{color:'#000',weight:1,fillColor:'#4a90e2',fillOpacity:0.5},
          filter: f=>['Austria','France','Germany','Italy','Portugal','Spain','Switzerland','United Kingdom'].includes(f.properties.NAME)
        },
        { name:'Canada', file:'ca.json', prop:'name', bounds:[[41,-141],[83,-52]], zoom:2,
          style:{color:'#000',weight:1,fillColor:'#4a90e2',fillOpacity:0.5}
        },
        { name:'Australia', file:'au.json', prop:'name', bounds:[[-44,112],[-10,154]], zoom:3,
          style:{color:'#000',weight:1,fillColor:'#4a90e2',fillOpacity:0.5}
        }
      ];
      let idx=0, countriesLayer, selectedLayer=null;
      let partiesData=[], currentCountry='';
      const prevBtn=document.getElementById('prevMap');
      const nextBtn=document.getElementById('nextMap');
      const mapTitle=document.getElementById('mapTitle');
      const selectedCountrySpan=document.getElementById('selectedCountry');
      const partyListEl=document.getElementById('partyList');
      const partySearch=document.getElementById('partySearch');
      const btnDownload=document.getElementById('btnDownload');

      const map=L.map('map',{attributionControl:false,zoomControl:false,boxZoom:false,doubleClickZoom:false}).setView([50,10],4);
      if(map.boxZoom)map.boxZoom.disable();if(map.doubleClickZoom)map.doubleClickZoom.disable();

      Papa.parse('DataPartiesPRUEBA.csv',{download:true,header:true,skipEmptyLines:true,complete:r=>partiesData=r.data});

      function loadMap(callback){
        const cfg=maps[idx];mapTitle.textContent=cfg.name;map.setMaxBounds(cfg.bounds);
        if(countriesLayer)map.removeLayer(countriesLayer);
        const center=[(cfg.bounds[0][0]+cfg.bounds[1][0])/2,(cfg.bounds[0][1]+cfg.bounds[1][1])/2];
        map.setView(center,cfg.zoom);
        fetch(cfg.file).then(r=>r.json()).then(data=>{
          let features=data.features.filter(f=>f.properties&&f.properties[cfg.prop]!==undefined);
          if(cfg.filter)features=features.filter(cfg.filter);
          countriesLayer=L.geoJSON({type:'FeatureCollection',features},{style:cfg.style,onEachFeature:(f,l)=>l.on('click',()=>selectCountry(f.properties[cfg.prop]))}).addTo(map);
          enhance();if(callback)callback();
        });
      }

      function enhance(){
        countriesLayer.eachLayer(l=>{
          l.on('mouseover',()=>l.setStyle({weight:3}));
          l.on('mouseout',()=>{if(l!==selectedLayer)l.setStyle({weight:1});});
        });
      }

      prevBtn.onclick=()=>{idx=(idx-1+maps.length)%maps.length;loadMap();};
      nextBtn.onclick=()=>{idx=(idx+1)%maps.length;loadMap();};

      function selectCountry(name){
        currentCountry=name;
        selectedCountrySpan.textContent=name;
        document.querySelectorAll('.country-item').forEach(el=>el.classList.toggle('active',el.textContent===name));
        const targetIdx=maps.findIndex(cfg=>cfg.name===name||(cfg.filter&&cfg.filter({properties:{[cfg.prop]:name}})));
        idx=targetIdx<0?0:targetIdx;
        loadMap(()=>{
          countriesLayer.eachLayer(l=>{
            if(l.feature.properties[maps[idx].prop]===name){
              if(selectedLayer)countriesLayer.resetStyle(selectedLayer);
              selectedLayer=l; l.setStyle({weight:4,color:'#000'});
                if (idx > 0) {
                const b = l.getBounds();
                map.setView(b.getCenter(), maps[idx].zoom);
                }
                buildChips();

            }
          });
        });
      }

      function buildChips(){
        const ps=Array.from(new Set(partiesData.filter(r=>r.COUNTRY===currentCountry).map(r=>r.PTYNAME))).sort();
        partyListEl.innerHTML='';partySearch.disabled=false;btnDownload.disabled=false;
        ps.forEach(p=>{const chip=document.createElement('div');chip.textContent=p;chip.className='party-chip selected';chip.onclick=()=>{chip.classList.toggle('selected');btnDownload.disabled=!partyListEl.querySelectorAll('.selected').length;};partyListEl.appendChild(chip);});
        partySearch.value='';partySearch.oninput=()=>partyListEl.childNodes.forEach(ch=>ch.style.display=ch.textContent.toLowerCase().includes(partySearch.value.toLowerCase())?'inline-block':'none');
      }

      btnDownload.onclick=()=>{
        const sel=Array.from(partyListEl.querySelectorAll('.selected')).map(c=>c.textContent);
        const filtered=partiesData.filter(r=>r.COUNTRY===currentCountry&&sel.includes(r.PTYNAME));
        if(!filtered.length){alert('Sin datos');return;}
        const data=filtered.map(r=>({Partido:r.PTYNAME,Líder:r.CR20PPGLDR||''}));
        const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(data),'Partidos');XLSX.writeFile(wb,`Partidos_${currentCountry}.xlsx`);
      };

      loadMap();
    });
  </script>
</body>
</html>
